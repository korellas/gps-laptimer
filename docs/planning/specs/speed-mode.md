# Speed Mode (가속 측정 모드)

**상태:** 📋 계획됨
**Phase:** 3.6 (UI/UX 향상)
**필요성:** 높음
**작업량:** 중 (2주)
**최종 업데이트:** 2026-02-18

---

## 1. 개요

랩타이머 모드와 별도로, 직선 가속 성능을 측정하는 **Speed Mode**.
0-100 km/h, 0-200 km/h 등 특정 속도 구간의 도달 시간을 GPS 기반으로 측정한다.

**왜 필요한가:**
- 서킷이 아닌 일반 도로/활주로에서도 사용 가능
- 차량 튜닝/세팅 변경 후 가속 성능 비교에 유용
- 랩타이머와 다른 사용 시나리오 → 제품 활용 범위 확대
- GPS만으로 구현 가능 (추가 센서 불필요)

---

## 2. 측정 모드

### 2.1 기본 측정 모드

| 모드 | 시작 조건 | 종료 조건 | 설명 |
|------|----------|----------|------|
| **0→100** | 정지 상태에서 출발 | 100 km/h 도달 | 가장 기본적인 가속 측정 |
| **0→200** | 정지 상태에서 출발 | 200 km/h 도달 | 고성능 차량용 |
| **0→60** | 정지 상태에서 출발 | 60 km/h 도달 | 시내 주행 체감 가속력 |
| **100→200** | 100 km/h 통과 시 | 200 km/h 도달 | 롤링 가속 (고속 성능) |

### 2.2 커스텀 모드

사용자가 시작/종료 속도를 직접 설정:
- **시작 속도:** 0~300 km/h (기본값: 0)
- **종료 속도:** 시작+10 ~ 350 km/h (기본값: 100)
- 예: 60→120, 80→180 등

---

## 3. 측정 로직

### 3.1 상태 머신

```
SpeedModeState:
  IDLE → READY → MEASURING → RESULT → IDLE
```

| 상태 | 설명 | 전환 조건 |
|------|------|----------|
| **IDLE** | 모드 진입 직후, 설정 가능 | 사용자가 측정 시작 버튼 터치 |
| **READY** | 측정 대기 중 | 시작 조건 충족 (아래 참조) |
| **MEASURING** | 가속 측정 진행 중 | 종료 속도 도달 |
| **RESULT** | 결과 표시 | 사용자 터치 → IDLE |

### 3.2 시작 감지

**0→X 모드 (정지 출발):**
```
1. READY 상태에서 속도 < SPEED_MODE_STANDSTILL_KMH (3 km/h) 확인
2. 속도가 SPEED_MODE_LAUNCH_THRESHOLD_KMH (5 km/h) 초과 시 측정 시작
3. 타이머 시작 시점: 보간으로 정확한 0 km/h 통과 시점 역추정
   - GPS 10Hz → 100ms 간격 사이의 정확한 시작점 보간
```

**X→Y 모드 (롤링 가속):**
```
1. READY 상태에서 속도 모니터링
2. 속도가 시작 속도를 상향 돌파 시 측정 시작
3. 보간으로 정확한 시작 속도 통과 시점 계산
```

### 3.3 종료 감지

```
1. 현재 속도 ≥ 종료 속도 감지
2. 보간으로 정확한 종료 속도 도달 시점 계산:
   - t_end = t_prev + (targetSpeed - prevSpeed) / (currSpeed - prevSpeed) × Δt
3. 총 시간 = t_end - t_start
```

### 3.4 측정 취소/실패 조건

| 조건 | 동작 |
|------|------|
| 속도가 감소 (브레이크/리프트오프) | 경고 표시, 측정 계속 |
| 측정 중 GPS 신호 손실 (>1초) | 측정 무효 → IDLE |
| 타임아웃 (60초 내 미달성) | 측정 무효 → RESULT (미완료 표시) |
| 후진/정지 | 측정 취소 → READY |

---

## 4. UI 디자인

### 4.1 IDLE / READY 화면

```
┌────────────────────────────────────────────────────────────┐
│  SPEED MODE          0→100 km/h         [▼ 모드 선택]       │
│                                                             │
│          현재 속도: 0.0 km/h                                 │
│                                                             │
│     베스트: 4.32s    평균: 4.58s    시도: 12회               │
│                                                             │
│  ● GPS OK  SAT:12                       [ 측정 시작 ]        │
└────────────────────────────────────────────────────────────┘
```

### 4.2 MEASURING 화면

```
┌────────────────────────────────────────────────────────────┐
│  ▶ MEASURING         0→100 km/h                             │
│                                                             │
│         ███████████████████░░░░░░░░░░  72 km/h              │
│                                                             │
│              ⏱  3.21s                                       │
│                                                             │
│  0    20    40    60    80    100                            │
└────────────────────────────────────────────────────────────┘
```

주요 표시:
- **대형 속도 프로그레스 바**: 시작→종료 속도 범위의 현재 진행률
- **실시간 경과 시간**: 큰 폰트
- **현재 속도**: 숫자 표시
- **구간 속도 마커**: 0→60, 0→80 등 중간 구간 시간 (0→100 측정 중 자동)

### 4.3 RESULT 화면

```
┌────────────────────────────────────────────────────────────┐
│  ✓ COMPLETE          0→100 km/h                             │
│                                                             │
│                    4.32 s                                    │
│                                                             │
│  0→60: 2.41s   0→80: 3.12s   0→100: 4.32s                  │
│  vs 베스트: -0.15s (▼ NEW BEST!)                             │
│                                                             │
│  [다시 측정]                    [히스토리]                    │
└────────────────────────────────────────────────────────────┘
```

### 4.4 히스토리 화면

```
┌────────────────────────────────────────────────────────────┐
│  SPEED HISTORY       0→100 km/h                  [← 돌아가기]│
│                                                             │
│  #1  ★ 4.32s   2026-02-18 14:23   0→60: 2.41s              │
│  #2    4.45s   2026-02-18 14:21   0→60: 2.48s              │
│  #3    4.58s   2026-02-18 14:19   0→60: 2.55s              │
│  #4    4.61s   2026-02-18 14:17   0→60: 2.57s              │
│                                                             │
│  평균: 4.49s   베스트: 4.32s   시도: 4회                     │
└────────────────────────────────────────────────────────────┘
```

---

## 5. 데이터 구조

### 5.1 측정 결과

```cpp
struct SpeedRunResult {
    float startSpeedKmh;          // 시작 속도 (0 = 정지 출발)
    float endSpeedKmh;            // 종료 속도 (100, 200, ...)
    uint32_t totalTimeMs;         // 총 소요 시간

    // 중간 구간 시간 (자동 기록)
    uint32_t splitTimes[8];       // 20, 40, 60, 80, 100, 120, 150, 200 km/h 도달 시간
    uint8_t splitCount;           // 유효한 split 수

    // 메타데이터
    float maxSpeedKmh;            // 측정 중 최고 속도
    uint32_t timestampUnix;       // 측정 시각 (Unix timestamp)
    bool isComplete;              // 목표 속도 달성 여부

    // GPS 품질
    uint8_t avgSatCount;          // 평균 위성 수
    float avgHdop;                // 평균 HDOP
};
```

### 5.2 세션 데이터

```cpp
struct SpeedModeSession {
    float targetStartSpeed;       // 목표 시작 속도
    float targetEndSpeed;         // 목표 종료 속도
    SpeedRunResult runs[MAX_SPEED_RUNS];  // 측정 결과 배열
    uint16_t runCount;            // 총 시도 횟수
    uint16_t bestRunIndex;        // 베스트 기록 인덱스
};
```

### 5.3 config.h 추가 상수

```cpp
// Speed Mode
constexpr float SPEED_MODE_STANDSTILL_KMH = 3.0f;        // 정지 판정 속도
constexpr float SPEED_MODE_LAUNCH_THRESHOLD_KMH = 5.0f;   // 출발 감지 속도
constexpr unsigned long SPEED_MODE_TIMEOUT_MS = 60000;     // 측정 타임아웃
constexpr int MAX_SPEED_RUNS = 50;                         // 세션당 최대 측정 횟수
constexpr float SPEED_MODE_SPLITS[] = {20, 40, 60, 80, 100, 120, 150, 200}; // 자동 split
```

---

## 6. 기술 세부사항

### 6.1 GPS 기반 속도 정확도

- u-blox NAV-PVT의 `gSpeed` (ground speed) 사용: mm/s 단위, 정확도 ±0.05 m/s (≈ ±0.18 km/h)
- 10Hz 업데이트 → 100ms 간격 보간으로 ±50ms 정확도
- HDOP < 2.0 조건에서만 측정 허용 (GPS 품질 보장)
- 보간 알고리즘으로 시작/종료 시점 정밀 계산

### 6.2 보간 알고리즘

```
두 연속 GPS 샘플 사이에서 목표 속도 도달 시점 추정:

  t_prev: 이전 샘플 시각,  v_prev: 이전 속도
  t_curr: 현재 샘플 시각,  v_curr: 현재 속도
  v_target: 목표 속도

  if v_prev < v_target <= v_curr:
    ratio = (v_target - v_prev) / (v_curr - v_prev)
    t_target = t_prev + ratio × (t_curr - t_prev)
```

### 6.3 모드 전환

- 기존 `GPSMode` enum 확장 또는 별도 `AppMode` 상위 모드 추가
- 시작 화면에서 LAPTIMER / SPEED MODE 선택
- Speed Mode 진입 시 트랙 감지 불필요 (위치 무관)

### 6.4 저장소

- SPIFFS 또는 SD 카드에 JSON/바이너리로 결과 저장
- 파일: `/speed_runs/{date}_{mode}.dat`
- WiFi 웹 UI에서 결과 조회/다운로드 (Phase 4.2 이후)

---

## 7. 의존성

| 의존 항목 | Phase | 필수 여부 |
|----------|-------|----------|
| GPS 하드웨어 모드 | Phase 0 ✅ | 필수 |
| 시작 화면 (모드 선택) | Phase 2.4 ✅ | 필수 |
| 터치 UI | Phase 3.1 | 높음 (모드 선택, 설정 변경) |
| SD 카드 저장 | Phase 4.1 | 선택 (SPIFFS 폴백 가능) |
| WiFi 결과 내보내기 | Phase 4.2 | 선택 |

---

## 8. 구현 우선순위

1. **P1**: 상태 머신 + 0→100 측정 로직 (백엔드)
2. **P1**: MEASURING 화면 (실시간 속도 + 경과 시간)
3. **P1**: RESULT 화면 (결과 + 중간 구간)
4. **P2**: 모드 선택 UI (0→100, 0→200, 커스텀)
5. **P2**: 히스토리 + 베스트 기록 관리
6. **P3**: 커스텀 속도 범위 설정
7. **P3**: 결과 저장/내보내기

---

## 참조

- **features-backlog:** [../features-backlog.md](../features-backlog.md)
- **roadmap:** [../roadmap.md](../roadmap.md) Phase 3.6
- **GPS 속도 정확도:** u-blox NAV-PVT gSpeed field (±0.05 m/s)
