# GPS 랩 타이머 로드맵

**최종 업데이트:** 2026-02-16

이 로드맵은 GPS 랩 타이머 프로젝트의 계획된 개발 단계를 설명합니다.
모든 백로그 아이디어를 **구현 필요성** 기준으로 평가하여 Phase별로 배치했습니다.

---

## Phase 0: 핵심 안정성 ✅ (완료)

**상태:** 2026-02-08 완료
**목표:** 단일 트랙 지원으로 안정적인 핵심 기능

### 완료된 기능
- ✅ GPS 하드웨어 모드 (u-blox G10A-F33)
- ✅ 시뮬레이션 모드 (에버랜드 트랙 재생)
- ✅ 델타 계산 (시간 + 속도)
- ✅ 섹터 타이밍 (3 섹터)
- ✅ LVGL UI (640×172 가로)
- ✅ SPIFFS 저장소
- ✅ 시리얼 CLI
- ✅ 성능 최적화
- ✅ AppContext 패턴
- ✅ 문서화 (초기)

---

## Phase 1: 코드 정리 ✅ (완료)

**목표일:** 2026-02 3주차
**목표:** 깔끔한 코드베이스, SSOT 문서화, 전력 최적화

### 완료됨
- ✅ **문서화 재구성** — SSOT 구조 완료
  - reference/, planning/, development/, guides/ 구조
  - docs/README.md 인덱스
  - 참조 문서 (아키텍처, 하드웨어, UI, 데이터 구조, 빌드, 트랙)
- ✅ **빠른 시작 가이드** — guides/quick-start.md
- ✅ **코드 리팩토링** (2026-02-16) — Phase 0~3 실행
  - 결과: [../development/code-review-2026-02-16-final.md](../development/code-review-2026-02-16-final.md)
- ✅ **전력 관리 활성화** — PM DFS (80-160MHz), Tickless Idle, WiFi 라이프사이클
- ✅ **데드 코드 제거** — `sector.cpp/h` 삭제, 미구현 선언 8개 제거
- ✅ **컴파일러 경고 수정** — 프로젝트 코드 0 warnings (httpd_uri 초기화, dns_server.h)
- ✅ **핫패스 최적화** — LVGL 플러시 200→50ms, 시간 업데이트 1Hz, lvgl_mutex 경합 분리
- ✅ **프로덕션 빌드** — `sdkconfig.defaults.prod` (WARN 로그, silent assertions)
- ✅ **GPS 구현** — Baud rate 115200, CFG-RATE 10Hz, Automotive, 필터/DR 연결, newData 플래그

**완료 기준:**
- [x] 미사용 모듈 없음
- [x] 메인 코드에 컴파일러 경고 없음
- [x] 전력 관리 활성화 (PM + Tickless)
- [x] 프로덕션용 sdkconfig.prod 생성
- [ ] SSOT 준수: 100% (문서 동기화 진행 중)

---

## Phase 2: 다중 트랙 + 실전 대비 📋 (계획됨)

**목표일:** 2026-03
**목표:** 여러 트랙 지원 + 트랙 현장에서 실제 사용 가능한 상태

> **핵심 원칙:** 이 Phase 이후에는 장비를 들고 트랙에 가서 바로 쓸 수 있어야 한다.

### 기능

#### 2.1 트랙 템플릿 (우선순위: P1, 필수)
- 📋 **CSV 트랙 형식**
  - 트랙 데이터 형식 정의 (이름, 중심, 반경, 결승선, 섹터)
  - 트랙 템플릿용 CSV 파서
  - 참조: [specs/multi-track.md](specs/multi-track.md) (생성 예정)

- 📋 **내장 트랙**
  - 에버랜드 (기존)
  - 용인 (계획)
  - 인제 스피디움 (계획)
  - 태백 BMW 드라이빙 센터 (계획)
  - 영암 F1 서킷 (계획)

#### 2.2 트랙 자동 감지 (우선순위: P1, 필수)
- 📋 **GPS 기반 감지**
  - 트랙 중심점까지 Haversine 거리
  - 반경 기반 매칭
  - GPS fix 시 자동 트랙 선택

- 📋 **수동 재정의**
  - 트랙 선택용 시리얼 명령
  - 터치 UI 트랙 선택 (Phase 3)

#### 2.3 레퍼런스 랩 관리 (우선순위: P2, 높음)
- 📋 **다중 레퍼런스 지원**
  - 트랙당 빠름/중간/느림 레퍼런스 랩
  - CLI/UI를 통한 사용자 선택
  - 사용자 지정 레퍼런스용 SPIFFS 저장소

#### 2.4 시작 화면 ✅ (구현 완료, 2026-02-15)
- ✅ **부팅 시퀀스 UI**
  - "GPS LAPTIMER" + 버전 표시 (Share Tech Mono 56pt)
  - 모드 선택: 시뮬레이션/GPS (스와이프/탭)
  - GPS fix 대기 화면 (위성 수, 상태 애니메이션)
  - 전화번호판 입력 (선택)
  - StartupState 상태 머신 (6단계)
  - 초기화 완료 시 자동 전환

#### 2.5 배터리 백분율 표시 + 사용률 추적 ✅ (구현 완료, 2026-02-15)
- ✅ **배터리 ADC 모니터링** - 전용 FreeRTOS 태스크 (Core 1)
  - IO4 ADC + 1:3 분압기, ADC_ATTEN_DB_12
  - 13회 오버샘플링, 상하위 25% 트리밍, 중간값 평균
  - 21-entry LiPo LUT + 선형 보간 → SoC%
- ✅ **EWMA 방전율 추적** (alpha=0.05, 5분 시간 상수)
  - 남은 시간 예측 (`gApp.batteryMinLeft`)
- ✅ **배터리 아이콘** - Status Bar에 SoC 비례 fill
- ✅ **GPIO16 전원 OFF** - PWR 버튼 롱프레스 또는 저배터리 자동 종료

#### 2.6 GPS 구현 문서화 (우선순위: P2, 높음) 🆕
- 📋 **GPS 모듈 상세 문서**
  - UBX 프로토콜 구현 가이드
  - 초기화/설정 시퀀스
  - 문제 해결 가이드 (fix 안잡힘, 좌표 오류 등)
  - 작업량: 소 (2-3일)

- **구현 필요성:** GPS 문제 발생 시 디버깅에 필수. 현장에서 트러블슈팅 참고자료.

#### 2.7 GPS 테스트 페이지 (우선순위: P1, 필수) 🆕
- 📋 **GPS 진단 화면**
  - 시뮬레이션/GPS 모드 외에 별도 진단 페이지
  - 위성 수 (사용중/가시), fix 타입 (No Fix/2D/3D)
  - 현재 좌표 (위도/경도), 고도
  - 실시간 수신 Hz 측정 (NAV-PVT 수신 간격 카운트)
  - UBX 설정 확인: 보드레이트, 네비 레이트, GNSS 구성
  - 신호 품질: HDOP/PDOP (NAV-PVT에서 추출 가능)
  - 작업량: 소 (2-3일)

- **구현 필요성:** GPS 하드웨어 연결 후 설정이 제대로 적용됐는지 현장에서 즉시 확인 필수. 시리얼 없이 LCD에서 확인 가능해야 한다.

**완료 기준:**
- [ ] CSV 트랙 형식 정의 및 문서화
- [ ] 3개 이상 내장 트랙
- [ ] 자동 감지 기능 작동
- [ ] 시리얼을 통한 수동 트랙 선택
- [ ] 트랙당 최소 1개 레퍼런스 랩
- [ ] 시작 화면에서 GPS fix 상태 확인 가능
- [ ] 배터리 잔량 확인 가능
- [ ] GPS 테스트 페이지에서 설정/상태 확인 가능

---

## Phase 3: UI/UX 향상 📋 (계획됨)

**목표일:** 2026-04
**목표:** 터치 제어 + 데이터 시각화로 사용성 향상

> **핵심 원칙:** 시리얼 없이 터치만으로 모든 조작 가능. 주행 데이터를 시각적으로 이해할 수 있어야 한다.

### 기능

#### 3.1 터치 UI 설정 (우선순위: P1, 높음)
- 📋 **설정 메뉴**
  - 트랙 선택
  - 레퍼런스 랩 선택
  - 디스플레이 밝기
  - GPS/시뮬레이션 모드 토글

- 📋 **랩 히스토리 뷰어**
  - 과거 랩을 보기 위한 스와이프
  - 레퍼런스 랩 선택을 위한 탭
  - 오래된 랩 삭제

#### 3.2 실시간 그래프 (우선순위: P2, 중간) 🆕 확장
- 📋 **델타 그래프**
  - 델타 vs 거리 선 그래프
  - 색상 코딩 (녹색/빨간색)
  - 스크롤 윈도우 (최근 30초 또는 전체 랩)
  - LVGL 차트 위젯, 링 버퍼

- 📋 **랩 진행률 표시기** 🆕
  - 레퍼런스 랩 대비 0-100% 진행률
  - `trackDistanceM / totalLapDistance × 100`
  - 선형 바 또는 숫자 표시
  - 섹터 경계 마커 포함

- 📋 **선택 가능한 뷰** 🆕
  - 델타 vs 거리 / 속도 vs 거리 / 섹터 비교 / 랩 히스토리
  - 터치 스와이프 또는 탭으로 뷰 전환
  - 마지막 선택 뷰 기본 설정 저장
  - 전체화면 그래프 모드 (토글)

- 📋 **그래프 엔벨로프/스무딩** 🆕
  - 피크 홀드 + 지수 감쇠 (오디오 VU 미터 스타일)
  - 반투명 오버레이 렌더링
  - 의존: 그래프 렌더링 인프라 필요

- **구현 필요성:** 주행 중 실시간 시각적 피드백. 단, 640×172 화면에서 주행 중 볼 여유가 제한적이므로 "랩 완료 후 리뷰" 모드 고려.

#### 3.3 GPS 트랙 시각화 (우선순위: P3, 중간) 🆕
- 📋 **2D 탑다운 트랙 뷰**
  - lat/lng → 화면 x/y 좌표 투영
  - 현재 위치 마커 + 레퍼런스 랩 경로
  - 색상 코딩 (앞서면 녹색, 뒤지면 빨간색)
  - 섹터 경계 표시
  - 미니맵 모드 또는 전체화면 토글
  - 작업량: 중 (2주)

- **구현 필요성:** 시각적으로 매력적이지만 640×172 화면 제약이 큼. 랩 완료 후 리뷰용으로 가치 있음.
- **과제:** 가로로 긴 화면에 맞는 렌더링 최적화 필요

#### 3.4 테마 (우선순위: P3, 낮음)
- 📋 **사용자 지정 테마**
  - 라이트/다크 모드
  - 색상 구성표 선택

#### 3.5 애니메이션 (우선순위: P3, 낮음)
- 📋 **부드러운 전환**
  - 화면 전환
  - 그래프 애니메이션
  - 랩 완료 축하

**완료 기준:**
- [ ] 터치 기반 설정 기능
- [ ] 랩 히스토리 뷰어 작동
- [ ] 최소 1개 그래프 구현
- [ ] 랩 진행률 표시 작동

---

## Phase 4: 데이터 및 연결성 📋 (계획됨)

**목표일:** 2026-05
**목표:** 데이터 내보내기, 대용량 저장소, 무선 기능

> **핵심 원칙:** 세션 데이터를 잃지 않고, 집에서 분석할 수 있어야 한다.

### 기능

#### 4.1 SD 카드 데이터 영속성 (우선순위: P1, 높음) 🆕
- 📋 **SPIFFS → SD 카드 마이그레이션**
  - ESP-IDF SD/MMC 드라이버 (SPI 모드)
  - 파일 구조: `/tracks/`, `/laps/`, `/sessions/`, `/references/`
  - 트랙 설정 CSV + 랩 데이터 바이너리
  - SD 카드 없을 시 SPIFFS 폴백
  - 작업량: 중 (2주)

- **구현 필요성:** SPIFFS 용량 한계로 장기 사용 불가. 수십 랩이면 꽉 참. 데이터 보존에 필수.
- **선행 조사:** 보드에 SD 카드 슬롯 있는지, SPI 핀 할당 확인

#### 4.2 WiFi 데이터 내보내기 (우선순위: P1, 높음)
- 📋 **WiFi 파일 전송**
  - CSV/GPX로 랩 데이터 내보내기
  - 웹 기반 파일 브라우저
  - WiFi AP 모드 또는 스테이션 모드
  - SD 카드 파일시스템 탐색 (SD 카드 사용 시)

#### 4.3 트랙/섹터 설정 웹 인터페이스 (우선순위: P2, 중간) 🆕
- 📋 **웹 기반 트랙 관리**
  - ESP-IDF HTTP 서버 + 임베디드 프론트엔드
  - 트랙 CSV 업로드/다운로드
  - 트랙 파라미터 편집 (결승선, 섹터, 경계)
  - 변경사항 검증 및 미리보기
  - 작업량: 중 (2-3주)

- **구현 필요성:** 새 트랙 추가 시 펌웨어 수정 없이 설정 가능. 다중 트랙 관리 편의성.
- **의존:** WiFi (4.2) + 다중 트랙 (Phase 2)

#### 4.4 OTA 업데이트 (우선순위: P1, 높음)

> **상세 설계:** [specs/ota-design.md](specs/ota-design.md)

- 📋 **WiFi OTA** (캡티브 포털, 주력)
  - 기존 WiFi captive portal 확장 (`/api/ota/upload` 엔드포인트)
  - 스마트폰 브라우저에서 `.bin` 파일 업로드 → OTA 기록
  - WebSocket으로 진행률 실시간 표시
  - 배터리 장착 상태에서도 안정적 (USB 전류 제한 문제 회피)

- 📋 **BLE OTA** (Web Bluetooth, 주력) 🆕
  - NimBLE GATT 서비스 (OTA Control/Data/Status 3개 Characteristic)
  - GitHub Pages 웹앱에서 Chrome Web Bluetooth API로 연결
  - 512B 청크 전송, ~10-15 KB/s, 1.5MB 펌웨어 → ~2분
  - 앱 설치 불필요 — 브라우저만으로 업데이트

- 📋 **ESP Web Tools 웹 플래셔** (USB, 보조)
  - GitHub Pages에 정적 웹페이지 호스팅
  - Web Serial API로 브라우저에서 직접 USB 플래시 (Chrome/Edge)
  - 초기 플래시 또는 파티션 변경 시 사용

- 📋 **GitHub Actions CI/CD**
  - 릴리즈 태그 (예: `v0.5.0`) 푸시 시 자동 빌드
  - `espressif/idf:v5.5.2` Docker 컨테이너
  - 빌드된 `.bin`을 GitHub Release에 자동 첨부
  - 태그에서 `APP_VERSION` 자동 주입

- 📋 **파티션 테이블 재설계**
  - factory → ota_0 + ota_1 듀얼 구성 (각 3MB)
  - otadata 파티션 추가 (롤백 상태 관리)
  - `CONFIG_BOOTLOADER_APP_ROLLBACK_ENABLE=y`
  - ⚠️ 1회 전체 플래싱 필요 (SPIFFS 데이터 소실)

- 📋 **GitHub Pages 웹앱** 🆕
  - Vanilla JS (빌드 도구 불필요)
  - Web Bluetooth API로 BLE OTA
  - GitHub Releases API에서 최신 바이너리 자동 확인
  - 진행률 표시 + 버전 비교

- **안전장치:** 배터리 30% 미만 시 거부, SHA256 검증, 롤백 지원, 라디오 배타성 (WiFi/BLE 동시 사용 안함)
- **작업량:** 대 (3-4주)

#### 4.5 블루투스 LE 데이터 스트리밍 (우선순위: P3, 낮음)
- 📋 **실시간 데이터 스트리밍** (선택사항)
  - BLE OTA의 NimBLE 인프라 재활용
  - BLE GATT 서비스 (델타, 속도, 섹터, 랩 타임)
  - 모바일 앱 통합 (React Native 또는 Flutter)
  - 작업량: 중 (2주)

- **구현 필요성:** 4.4에서 NimBLE 이미 활성화되므로 추가 비용 낮아짐. 단, 모바일 앱 개발 필요.

#### 4.6 클라우드 통합 (우선순위: P3, 낮음)
- 📋 **클라우드 동기화** (선택사항)
  - 랩 데이터 백업
  - 다중 기기 동기화
  - 리더보드

- **구현 필요성:** 서버 인프라 + 유지보수 비용. WiFi 내보내기로 대체 가능.

**완료 기준:**
- [ ] SD 카드 또는 확장 저장소 작동
- [ ] WiFi 파일 내보내기 작동
- [ ] OTA 업데이트 기능
- [ ] 웹 트랙 설정 (선택사항)

---

## Phase 5: 고급 기능 📋 (향후)

**목표일:** 2026 Q3+
**목표:** 프로 수준 분석 + 하드웨어 확장

> **핵심 원칙:** 기본 기능이 안정된 후 고급 분석과 외부 하드웨어 연동.

### 기능

#### 5.1 고급 분석
- 📋 **세그먼트 분석**
  - 코너별 분석
  - 제동점 감지
  - 레이싱 라인 분석

- 📋 **예측 랩 타임**
  - 현재 섹터 델타 기반 완주 시간 예측
  - GPS 데이터만으로 구현 가능 (가속도계 불필요)

#### 5.2 오디오/음성 피드백 🆕
- 📋 **오디오 통합**
  - 보드 마이크/스피커 핀 조사 (하드웨어 선행)
  - 기본 비프/톤: 랩 완료, 섹터 전환, 저배터리
  - 음성 안내 (확장): "랩 완료, 1분 23초", "베스트 랩!"
  - 작업량: 중 (2-3주)

- **구현 필요성:** 주행 중 화면을 볼 수 없으므로 오디오 피드백은 이론적으로 매우 유용. 단, 하드웨어 제약(내장 스피커 유무)이 결정적. 비프음만이라도 가치 있음.
- **선행 조사 필수:** 회로도에서 스피커/앰프 핀 확인

#### 5.3 가속도계/텔레메트리 🆕
- 📋 **G-force 추적**
  - 외부 가속도계 모듈 (MPU-6050 등)
  - 측면/종방향 G 측정
  - GPS와 센서 융합
  - 코너링 속도/제동점 분석
  - 작업량: 대 (3주)

- **구현 필요성:** 프로 수준 분석에 가치 있지만, 외부 하드웨어 + 장착 + 캘리브레이션 필요. 우선순위 낮음.

#### 5.4 비디오 동기화 🆕
- 📋 **대시캠 데이터 연동**
  - 타임스탬프 포함 랩 데이터 CSV 내보내기
  - 타사 소프트웨어 연동 (RaceRender 등)
  - ESP32 자체 비디오 처리는 불가 → 외부 도구 활용

- **구현 필요성:** ESP32에서 직접 처리 불가. CSV 내보내기 (Phase 4)가 완료되면 외부 도구로 자연스럽게 해결됨. 추가 구현 최소.

#### 5.5 경쟁 기능
- 📋 **다중 차량 지원**
  - 다른 드라이버와 비교 (세션 후)
  - 갭 계산

- 📋 **레이스 모드**
  - 예선 → 레이스 워크플로우
  - 그리드 위치
  - 레이스 결과

**완료 기준:**
- [ ] 세그먼트 분석 작동
- [ ] 오디오 비프/톤 (하드웨어 가능 시)
- [ ] CSV 내보내기로 비디오 도구 연동 확인

---

## 보류 (현재 구현 필요성 낮음)

구현 가치가 낮거나 인프라/센서가 없어서 보류된 아이디어:

| 아이디어 | 보류 이유 |
|----------|----------|
| 피트 타이머 | 트랙 데이 위주, 피트 스톱 거의 없음 |
| 연료 소비 추적 | 연료 센서 연결 불가 |
| 타이어 마모 추정 | 센서 없이 추측적 |
| 날씨 통합 | WiFi + 외부 API 필요, 제한된 가치 |
| 소셜 기능 (랩 공유) | 클라우드 백엔드 + 앱 필요, 과도한 노력 |
| 음성 명령 | 소음 환경에서 인식률 낮음, DSP/클라우드 필요 |

### 거부됨
| 아이디어 | 거부 이유 |
|----------|----------|
| 실시간 다중 차량 GPS | 다중 기기 + 서버 인프라 필요 |
| AI 코칭 | 대규모 ML 모델/데이터 필요, ESP32에서 불가 |

---

## 버전 목표

| 버전 | Phase | 목표일 | 주요 기능 |
|---------|-------|-------------|--------------|
| **0.3.x** | Phase 1 | 2026-02 | 코드 정리, 문서화, 전력 최적화 |
| **0.4.0** | Phase 2 | 2026-03 | 다중 트랙 (시작 화면, 배터리 구현 완료) |
| **0.5.0** | Phase 3 | 2026-04 | 터치 UI, 그래프, 트랙 시각화 |
| **0.6.0** | Phase 4 | 2026-05 | SD 카드, WiFi, OTA, 웹 설정 |
| **1.0.0** | Phase 5 | 2026 Q3 | 고급 분석, 오디오 |
| **2.0.0** | TBD | TBD | 경쟁 기능 |

---

## 우선순위 범례

| 우선순위 | 의미 | 일정 |
|----------|---------|----------|
| **P0** | 중요 | 이번 주 |
| **P1** | 높음 | 이번 달 |
| **P2** | 중간 | 이번 분기 |
| **P3** | 낮음 | 다음 분기+ |

### 구현 필요성 등급

| 등급 | 의미 |
|------|------|
| **필수** | 트랙에서 실제 사용하려면 반드시 필요 |
| **높음** | 사용성을 크게 향상시키는 기능 |
| **중간** | 있으면 좋지만, 없어도 핵심 기능에 영향 없음 |
| **낮음** | 장식적이거나 하드웨어 제약이 있는 기능 |

---

## 의존성

### Phase 1 → Phase 2
- 깔끔한 코드베이스로 다중 트랙이 더 쉬움
- 복잡성 추가 전 문서화 완료

### Phase 2 → Phase 3
- 터치 UI 전 트랙 선택 작동 필요
- 트랙 선택기를 유용하게 만들기 위해 여러 트랙 필요

### Phase 3 → Phase 4
- WiFi 설정용 터치 UI
- OTA 설정용 설정 메뉴

### Phase 4 → Phase 5
- CSV 내보내기가 비디오 동기화의 기반
- SD 카드가 오디오 샘플 저장에 필요

---

## 위험 및 완화

| 위험 | 영향 | 완화 |
|------|--------|------------|
| **GPS 정확도** | 중간 | 필터링, 데드 레코닝 사용 |
| **디스플레이 성능** | 낮음 | 이미 최적화됨 (30Hz 안정) |
| **메모리 제약** | 중간 | 정적 할당, 신중한 프로파일링 |
| **다중 트랙 복잡성** | 중간 | CSV로 시작, 반복 |
| **SD 카드 호환성** | 중간 | SPI 모드 사용, 폴백 지원 |
| **터치 UI 반응성** | 낮음 | LVGL이 잘 처리함 |
| **OTA 신뢰성** | 높음 | 롤백 지원, 버전 확인, 배터리 체크 |
| **BLE OTA 브라우저 호환** | 중간 | Web Bluetooth는 Chrome/Edge만 지원, WiFi OTA를 대안으로 |
| **파티션 마이그레이션** | 높음 | 1회 전체 플래시 필요, SPIFFS 데이터 소실 사전 안내 |
| **오디오 하드웨어** | 높음 | 회로도 조사 선행, 불가 시 스킵 |

---

## 성공 지표

### Phase 1
- 코드베이스 < 7,500줄 (현재 ~8,000)
- 컴파일러 경고 제로
- 문서화 커버리지 100%

### Phase 2
- 5개 이상 트랙 지원
- 트랙 자동 감지 90%+ 정확도
- 트랙 전환 < 1초
- 부팅 시 GPS fix 상태 표시
- 배터리 잔량 정확도 ±5%

### Phase 3
- 터치 응답 < 100ms
- 설정 저장/로드 < 500ms
- 그래프 렌더링 30 Hz

### Phase 4
- SD 카드 읽기/쓰기 안정
- OTA 성공률 95%+
- 랩당 파일 내보내기 < 5초
- WiFi 연결 < 10초

---

## 참조

- **현재 상태:** [../development/status.md](../development/status.md)
- **기능 백로그:** [features-backlog.md](features-backlog.md) (상세 아이디어)
- **변경 로그:** [../development/changelog.md](../development/changelog.md)
- **아키텍처:** [../reference/architecture.md](../reference/architecture.md)

---

**최종 검토:** 2026-02-16
**다음 검토:** 2026-02-23 (주간)
