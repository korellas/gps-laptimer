# Current Status Snapshot (2026-02-08)

This file summarizes the major behavior now present in the codebase so teammates can quickly align.

## Changes Since Last Snapshot (2026-02-06)

### 1) 시뮬레이션 델타 정확도 버그 수정
- **문제**: 샘플랩 4 (랩 1과 동일 데이터)가 ~0.05s 델타를 표시
- **원인**: `simulation.cpp`에서 `gApp.currentPoint.lapTimeMs = lapTimeMs` (월클럭 오버라이드)가 `calculateDelta()` 호출 **전에** 실행되어, GPS 데이터 타임스탬프가 월클럭으로 덮어씌워짐. 월클럭은 디스플레이 렌더링/시리얼 처리 오버헤드로 인해 ~30-50ms 체계적 오프셋이 있음.
- **수정**: 월클럭 오버라이드를 `calculateDelta()` **이후**로 이동
- **영향**: 시뮬레이션 모드만 (실제 GPS 모드는 영향 없음 - 동일 월클럭 기반)

### 2) 섹터 타이밍 구현 (신규 기능)
3섹터 분할 타이밍 시스템을 전체 파이프라인에 통합.

#### 수정 파일
- **`components/track/builtin_tracks.h`**: 섹터 경계 좌표 상수 추가
  ```cpp
  everland::SECTOR_1_2_LAT/LNG = 37.2974004, 127.2175125
  everland::SECTOR_2_3_LAT/LNG = 37.2961782, 127.2138076
  ```
- **`components/timing/sector_timing.h`**: `CurrentSectorTiming`에 `cumulativeDeltaAtExit[]` 추가, `onSectorComplete()` 시그니처에 `totalDeltaSeconds` 파라미터 추가
- **`components/timing/sector_timing.cpp`**:
  - `updateSectorDistancesFromReference()`: 레퍼런스 랩에서 섹터 좌표에 가장 가까운 포인트의 누적 거리를 경계로 사용
  - `checkSectorTransitionByDistance()`: 거리 기반 섹터 전환 감지
  - `onSectorComplete()`: 누적 델타 기록 및 섹터 델타 계산
- **`components/modes/simulation.cpp`**:
  - 초기화: `initSectorTiming()` + `updateSectorDistancesFromReference()` + `resetSectorTiming()`
  - GPS 루프: `calculateDelta()` 후 `checkSectorTransitionByDistance()` → `onSectorComplete()` → `onSectorEntry()`
  - 랩 완료: `resetSectorTiming()`, 베스트 랩 갱신 시 섹터 거리 재계산
- **`main/waveshare_display.cpp`**: 섹터 델타 표시 로직
  - 완료 섹터: 고정 `sectorDeltas[i]`
  - 현재 섹터: 실시간 `totalDelta - completedCumulativeDelta`
  - 색상: 흰색 (색상 코딩 없음)

#### 섹터 델타 계산 방식
```
누적 델타 방식:
  cumulativeDeltaAtExit[0] = totalDelta at S1 exit
  cumulativeDeltaAtExit[1] = totalDelta at S2 exit

  sectorDelta[0] = cumulativeDeltaAtExit[0]
  sectorDelta[1] = cumulativeDeltaAtExit[1] - cumulativeDeltaAtExit[0]
  sectorDelta[2] = finalDelta - cumulativeDeltaAtExit[1]

  합계: sectorDelta[0] + sectorDelta[1] + sectorDelta[2] = finalDelta
```

#### 알려진 한계
- 반올림 오차: 각 섹터 소수점 2자리 표시 시 합계가 전체 델타와 ±0.01 차이 가능 (부동소수점 포맷 한계, 무시 가능)

### 3) 디스플레이 업데이트
- 섹터 델타 레이블 (`lbl_sector_deltas[0..2]`) 좌측 배치 (x=8, y=42/68/94)
- Share Tech Mono 24pt 폰트 사용
- 랩 완료 오버레이 기능 추가 (이전 커밋)

## 현재 UI 레이아웃
```
┌───────────────────────────────────────────────────────────────────┐
│  S1 -0.42              LAP 01                   1:23.4           │
│  S2 +0.72                                     BEST 1:27:00       │
│  S3 -0.32               +1.34                                    │
│  ███████████████████████████████                      +1.2km/h    │
└───────────────────────────────────────────────────────────────────┘
```

## Files Most Relevant To These Changes
- `components/modes/simulation.cpp` (핵심 루프, 섹터 통합)
- `components/timing/sector_timing.cpp/h` (섹터 타이밍 로직)
- `components/track/builtin_tracks.h` (트랙 정의, 섹터 좌표)
- `main/waveshare_display.cpp` (디스플레이, 섹터 델타 표시)

## 빌드 상태
- 빌드 성공 (경고: `sector.cpp:120` 미사용 변수 `currentSector` - 기존 경고)
- 바이너리 크기: 0xd57a0 bytes (86% free)

## Notes For Next Collaborator
- 섹터 경계 거리는 레퍼런스 랩에서 동적 계산됨. 레퍼런스가 바뀌면 자동 재계산.
- `sector_timing.cpp`의 섹터 좌표가 `builtin_tracks.h`에도 중복 정의됨 (하드코딩). 멀티 트랙 지원 시 통합 필요.
- `sector.cpp`의 `updateSectorDetection()`은 현재 호출되지 않음. `sector_timing.cpp`의 거리 기반 방식이 실제 사용됨.
- 코드 리뷰 문서(`docs/code_review_2026-02-07.md`)의 리팩토링 이슈들은 아직 미처리.
