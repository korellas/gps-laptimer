# 에버랜드 트랙 사양

**상태:** 2026-02-14 기준 최신
**SSOT:** 에버랜드 트랙 데이터의 단일 정보원

## 1. 트랙 개요

| 매개변수 | 값 |
|----------|-----|
| **이름** | Everland (에버랜드) |
| **위치** | 대한민국 경기도 용인 |
| **트랙 유형** | 로드 코스 / 카트 서킷 |
| **방향** | 시계 방향 |
| **총 길이** | ~12,881 미터 (12.88 km) |
| **섹터 수** | 3 (S1, S2, S3) |

## 2. 결승선

### 2.1 좌표

| 포인트 | 위도 | 경도 |
|--------|------|------|
| **포인트 A** | 37.296096°N | 127.206860°E |
| **포인트 B** | 37.296159°N | 127.206621°E |

### 2.2 기하학

```
         N (0°)
         ↑
         │
    B    │    A
    •────┼────•  ← 결승선
         │
       트랙
```

**선 방향:** A → B (대략 동쪽에서 서쪽)
**선 길이:** ~21.8 미터
**고도:** ~해발 150m (대략)

### 2.3 유효 통과 방향

| 매개변수 | 값 |
|----------|-----|
| **방향 범위** | 315° ~ 45° (북향) |
| **유효 접근** | 남쪽에서 북쪽으로 (시계방향 랩 완료) |
| **데드 존** | 결승선 주변 30미터 |
| **최소 랩 타임** | 30초 |

**방향 정의:**
- 0° = 북
- 90° = 동
- 180° = 남
- 270° = 서
- 북쪽에서 시계 방향으로 측정

**왜 315°~45°인가?**
- 차량이 북향으로 이동하는지 확인
- 남향 교통에 의한 잘못된 트리거 방지
- ±45° 방향 변동 허용

## 3. 섹터 레이아웃

### 3.1 섹터 경계

| 경계 | 이름 | 위도 | 경도 | 시작점으로부터 거리 |
|------|------|------|------|-------------------|
| **시작** | 결승선 | 37.296096°N | 127.206860°E | 0 m |
| **S1→S2** | 섹터 1 종료 | 37.2974004°N | 127.2175125°E | ~6,121 m |
| **S2→S3** | 섹터 2 종료 | 37.2961782°N | 127.2138076°E | ~11,382 m |
| **Finish** | 섹터 3 종료 | 37.296096°N | 127.206860°E | ~12,881 m |

### 3.2 섹터 길이

| 섹터 | 대략적 길이 | 설명 |
|------|-----------|------|
| **S1** | ~6,121 m (47.5%) | 시작 → 트랙의 첫 번째 1/3 |
| **S2** | ~5,261 m (40.8%) | 중간 구간 |
| **S3** | ~1,499 m (11.7%) | 결승까지 마지막 구간 |

### 3.3 감지 방법

**방법:** 거리 기반 감지
**트리거:** `trackDistanceM >= sectorBoundaryDistance`

**경계 계산:**
1. 누적 거리가 있는 레퍼런스 랩 로드
2. 각 섹터 경계 좌표에 가장 가까운 포인트 찾기
3. 해당 포인트의 누적 거리를 경계 임계값으로 저장
4. 랩 진행 중 현재 `trackDistanceM`을 임계값과 비교

**구현:**
- 파일: `components/timing/sector_timing.cpp`
- 함수: `updateSectorDistancesFromReference()`
- 트리거: `checkSectorTransitionByDistance(trackDistanceM)`

## 4. 레퍼런스 랩 데이터

### 4.1 레퍼런스 랩 (베스트 타임)

| 매개변수 | 값 |
|----------|-----|
| **랩 타임** | 52.83초 |
| **소스 파일** | `examples/everland_reference_5283.h` |
| **포인트 수** | ~1,200 포인트 |
| **샘플 레이트** | ~20 Hz (50ms 간격) |
| **최대 속도** | ~180 km/h |
| **평균 속도** | ~87.7 km/h |

### 4.2 데이터 형식

```cpp
// examples/everland_reference_5283.h
const GPSPoint everlandReference[] = {
    {37.296096, 127.206860, 0, 0, 0.0, 0.0},        // 시작
    {37.296123, 127.206875, 50, 50, 15.2, 12.5},   // +50ms
    {37.296145, 127.206892, 100, 100, 28.7, 14.8}, // +100ms
    // ... ~1200 포인트
};
const int everlandReferenceCount = sizeof(everlandReference) / sizeof(GPSPoint);
```

### 4.3 누적 거리

`LapData.cumulativeDistances[]`에 사전 계산됨:
```
[0.0, 15.2, 32.7, 48.5, ..., 12881.0]
```

**계산:**
- 방법: 연속 포인트 간 하버사인 거리
- 최적화: 사전 계산된 cos(lat)를 사용한 `fastDistanceMetersPrecomp()`
- 참조: `components/timing/delta_calculator.cpp` → `calculateCumulativeDistances()`

## 5. 시뮬레이션 데이터

### 5.1 샘플 랩

**파일:** `examples/everland_track_data.h`

| 랩 | 시간 | 포인트 | 설명 |
|-----|------|--------|------|
| **Lap 1** | 54.12s | ~1,200 | 레퍼런스보다 약간 느림 |
| **Lap 2** | 52.98s | ~1,200 | 레퍼런스에 가까움 |
| **Lap 3** | 53.45s | ~1,200 | 중간 페이스 |
| **Lap 4** | 55.67s | ~1,200 | 느림, 더 많은 오류 |

### 5.2 데이터 구조

```cpp
// examples/everland_track_data.h
struct SimulationLap {
    const char* name;
    const GPSPoint* points;
    int pointCount;
    unsigned long totalTimeMs;
};

extern const SimulationLap everland_laps[];
extern const int everland_lap_count;
```

## 6. 트랙 특성

### 6.1 예상 성능

| 지표 | 빠른 랩 | 중간 랩 | 느린 랩 |
|------|---------|---------|---------|
| **랩 타임** | 50-53s | 53-58s | 58-70s |
| **최대 속도** | 170-190 km/h | 150-170 km/h | 130-150 km/h |
| **평균 속도** | 85-95 km/h | 75-85 km/h | 65-75 km/h |

### 6.2 검증 범위

```cpp
// config.h
#define MIN_LAP_TIME_MS 30000   // 30초 (안전)
#define MAX_LAP_TIME_MS 180000  // 3분 (타임아웃)
```

**목적:**
- 잘못된 트리거 거부 (예: 주차, U턴)
- 멈춘 랩 타임아웃 (GPS 손실, 트랙에서 정지)

## 7. 트랙 정의 (코드)

### 7.1 TrackLayout 구조

**파일:** `components/track/builtin_tracks.h`

```cpp
const TrackLayout EVERLAND_TRACK = {
    .name = "Everland",

    // 결승선
    .finishLat1 = 37.296096,
    .finishLng1 = 127.206860,
    .finishLat2 = 37.296159,
    .finishLng2 = 127.206621,
    .finishHeadingMin = 315.0f,
    .finishHeadingMax = 45.0f,

    // 섹터
    .numSectors = 3,
    .sectorBoundaries = {
        {37.2974004, 127.2175125, "S1→S2"},
        {37.2961782, 127.2138076, "S2→S3"},
        {37.296096,  127.206860,  "S3→Finish"}
    }
};
```

## 8. GPS 고려사항

### 8.1 정확도 요구사항

| 매개변수 | 요구사항 | 일반적인 GPS |
|----------|---------|------------|
| **위치 정확도** | ±5 미터 | ±3-10 미터 |
| **속도 정확도** | ±2 km/h | ±1-3 km/h |
| **업데이트 속도** | 10 Hz | 10-25 Hz |
| **Fix 유형** | 3D fix | 3D fix (6개 이상 위성) |

### 8.2 문제 영역

| 영역 | 문제 | 완화 방법 |
|------|------|----------|
| **나무/건물** | 신호 손실 | 데드 레코닝, 필터링 |
| **터널** | 완전 손실 | 마지막 알려진 위치 + 외삽 |
| **다중경로** | 위치 점프 | 스파이크 감지, 스무딩 |

**참조:** 필터링 구현은 `components/geo/gps_filter.cpp` 참조

## 9. 좌표 참조

모든 좌표는 **WGS84 데이텀** 사용:
- 십진 도
- 정밀도: 소수점 7-8자리 (~1-10cm 정확도)
- 형식: `lat, lng` (`lng, lat` 아님)

**예시:**
```
37.296096°N, 127.206860°E
= 37.296096, 127.206860 (코드 형식)
```

## 10. 테스트 시나리오

### 10.1 결승선 통과

**유효한 통과:**
```
이전: 37.295800, 127.206500 (선 남쪽)
현재: 37.296300, 127.207000 (선 북쪽)
방향: 350° (북향)
→ 랩 완료!
```

**잘못된 통과 (잘못된 방향):**
```
이전: 37.296300, 127.207000 (선 북쪽)
현재: 37.295800, 127.206500 (선 남쪽)
방향: 170° (남향)
→ 거부됨 (잘못된 방향)
```

### 10.2 섹터 전환

**S1 → S2:**
```
trackDistanceM: 6120.5 m
sectorBoundaryDistances[0]: 6121.0 m
→ 섹터 1 완료, 섹터 2 진입
```

**S2 → S3:**
```
trackDistanceM: 11382.7 m
sectorBoundaryDistances[1]: 11382.0 m
→ 섹터 2 완료, 섹터 3 진입
```

## 11. 데이터 파일

| 파일 | 목적 | 크기 |
|------|------|------|
| `examples/everland_reference_5283.h` | 레퍼런스 랩 (52.83s) | ~100 KB |
| `examples/everland_track_data.h` | 시뮬레이션 랩 (4 랩) | ~400 KB |
| `components/track/builtin_tracks.h` | 트랙 정의 | ~2 KB |

## 12. 향후 개선 사항

에버랜드 트랙 계획된 개선사항:

- [ ] 다중 레퍼런스 랩 (빠름/중간/느림)
- [ ] 트랙 세그먼트 분석 (코너, 직선)
- [ ] 이상적인 레이싱 라인 데이터
- [ ] 브레이크/가속 구역
- [ ] 트랙 표면 상태 데이터
- [ ] 날씨 상관관계

## 참조

- **아키텍처:** [../architecture.md](../architecture.md)
- **데이터 구조:** [../data-structures.md](../data-structures.md)
- **하드웨어:** [../hardware.md](../hardware.md)
- **소스 코드:** `components/track/builtin_tracks.h`, `examples/everland_reference_5283.h`
